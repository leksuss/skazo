# Пайплайн подготовки контента

## Общая идея
Пайплайн — это набор фоновых этапов + интерактивный ревью менеджером.
Этапы должны быть:
- асинхронными,
- наблюдаемыми,
- повторяемыми,
- частично переиспользуемыми (перегенерировать только затронутое).

## Этапы (концептуально)

### 1) Import (импорт)
Вход:
- файл (MVP: `.txt`, позже `.docx/.pdf` и URL).

Выход:
- RawText (сырой текст + метаданные источника).

### 2) Cleanup/Normalize (нормализация)
Детерминированные правила:
- кавычки/тире/пробелы,
- переносы строк,
- очистка мусора.

Опционально LLM:
- корректура “минимальные правки” + дифф.

Выход:
- NormalizedText + дифф к исходнику.

### 3) Structure (структурирование)
Цель:
- разбить на блоки (абзацы),
- предложить сцены,
- предложить якоря иллюстраций.

Гибрид:
- правила задают границы допустимого,
- LLM предлагает сцены/описания сцен и позиции якорей.

Выход:
- `StoryVersion` со сценами/блоками/якорями.

### 4) Plan Assets (планирование ассетов)
На основе сцен и пресета:
- какие сцены иллюстрировать,
- какие форматы нужны (соотношения сторон, размеры),
- сколько вариаций хранить.

Выход:
- набор `GenerationTask`.

### 5) Generate (генерация)
Интеграция с внешним API:
- изображения (MVP),
- позже видео.

Требования:
- ретраи,
- лимиты,
- идемпотентность,
- логирование параметров.

Выход:
- `Asset`(ы) со статусами.

### 6) Review (ревью менеджером)
Менеджер:
- листает сцены,
- смотрит соответствие тексту и стилю,
- принимает/отклоняет,
- запускает перегенерацию.

### 7) Publish (публикация)
Публикация привязывается к конкретной версии:
- версия становится “published/current”.

## Инкрементальность (важно)
Если менеджер поправил текст только в одной сцене:
- инвалидируем только связанные якоря/ассеты,
- остальное оставляем.
