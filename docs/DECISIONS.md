# DECISIONS (ADR-лог)

Этот файл фиксирует ключевые архитектурные решения, чтобы проект не “дрейфовал” при длительной разработке (особенно с помощью LLM).

Формат записи:
- **ID**: ADR-0001
- **Дата**
- **Статус**: proposed / accepted / superseded
- **Контекст**
- **Решение**
- **Причины**
- **Последствия**

---

## ADR-0001 — Канонический контент не хранит “страницы”
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: страницы зависят от устройства/шрифта/ориентации.
- **Решение**: хранить блоки/сцены/якоря, а пагинацию делать на клиенте.
- **Причины**: консистентность, переносимость, отсутствие N-вариантов страниц.
- **Последствия**: в читалке нужен layout/pagination engine; иллюстрации привязываются к якорям, а не к номеру страницы.

## ADR-0002 — “Практичный” стек MVP
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: нужен быстрый MVP с возможностью вырасти.
- **Решение**: Django + DRF, Postgres, Celery+Redis, S3/SeaweedFS (dev); менеджерка MVP в Django Admin; читалка на Vue.
- **Причины**: зрелые компоненты, хорошая интеграция, быстрый старт.
- **Последствия**: отдельный фронт админки можно вынести позже без ломки API.

## ADR-0003 — Асинхронный пайплайн через очередь
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: импорт/LLM/генерация медиа — долгие и нестабильные операции.
- **Решение**: все тяжёлые этапы выполняются как фоновые задачи; UI показывает статусы.
- **Причины**: ретраи, масштабирование, наблюдаемость, UX.
- **Последствия**: нужна модель задач/статусов и worker-инфраструктура.

## ADR-0004 — Человек в контуре (модерация результатов генерации)
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: требуется визуальная модерация соответствия сцене и стилю.
- **Решение**: менеджер подтверждает иллюстрации/видео; автосигналы качества — подсказки, не автомодерация.
- **Причины**: качество и предсказуемость важнее полной автоматизации на MVP.
- **Последствия**: нужен удобный Review UI (принять/перегенерировать/правки).

## ADR-0005 — Храним стиль как пакет (референсы + style bible) и версионируем
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: стиль должен быть воспроизводимым и переносимым между провайдерами.
- **Решение**: `StylePreset` включает референсы + текстовую выжимку + правила; любые изменения повышают ревизию.
- **Причины**: воспроизводимость, контроль инвалидации ассетов, миграции.
- **Последствия**: задачи генерации учитывают `style_preset_revision` в идемпотентном ключе.

## ADR-0006 — MVP-источник: файл `.txt` (URL-импорт позже)
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: умный парсинг ссылок может “съесть” время MVP.
- **Решение**: на MVP поддерживаем импорт из файла `.txt`, URL-краулинг — как расширение.
- **Причины**: быстрее выйти в сквозной цикл (текст → ассеты → ревью → публикация).
- **Последствия**: интерфейс импорта и модели источника должны позволять добавить URL-источники позже.

## ADR-0007 — LLM-разработка ведётся итерациями с контрактом ROADMAP
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: большой проект сложно сделать одним запросом, высокий риск несогласованности.
- **Решение**: вести `docs/ROADMAP.md` с задачами и DoD; делать маленькие проверяемые изменения.
- **Причины**: управляемость, контроль качества, снижение “дрейфа”.
- **Последствия**: любая крупная работа декомпозируется на задачи с критериями приёмки.

## ADR-0008 — Tests-first по умолчанию (как контракт для LLM)
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: LLM лучше работает при наличии проверяемых критериев; тесты снижают регрессии.
- **Решение**: придерживаться подхода “tests-first по умолчанию” для детерминированной логики и API; для UI и внешних интеграций допускаются исключения (моки/фикстуры/контрактные проверки вместо строгого TDD).
- **Причины**: ускорение разработки, снижение количества “скрытых” ошибок, стабильность итераций.
- **Последствия**: требования к задачам включают критерии проверки; тесты становятся частью Definition of Done.

## ADR-0009 — Dev object storage: SeaweedFS вместо MinIO
- **Дата**: 2025-12-28
- **Статус**: accepted
- **Контекст**: нужно S3-compatible хранилище для dev; есть сообщения, что MinIO в конце 2025 перешёл в maintenance mode (источник: новость на Habr).
- **Решение**: использовать SeaweedFS с S3 gateway в dev-окружении.
- **Причины**: снизить риск зависимости от компонента, который может не развиваться.
- **Последствия**: docker-compose/dev окружение и доки ориентируются на SeaweedFS; интерфейс работы с медиа остаётся S3-compatible.
