# MVP: практичная архитектура на выбранных технологиях

Этот документ фиксирует текущее “приземление” на инструменты для MVP.
Если в будущем стек поменяется — концепции из `01–07` должны остаться актуальными.

## Выбранная связка
- Backend/API: **Django + DRF**
- DB: **PostgreSQL**
- Очередь: **Celery + Redis**
- Медиа: **S3-compatible** (dev: SeaweedFS (S3), prod: S3/R2)
- Менеджерка MVP: **Django Admin + кастомные admin views**
- Читалка: **Vue** (позже можно Nuxt)
- Обновления статусов: MVP **polling**, позже WebSocket (**Django Channels** или отдельный realtime слой)

## Сервисы (логическое разбиение)

### 1) `web` (Django)
Ответственность:
- REST API для читалки и менеджерки
- авторизация/роли
- хранение моделей: Story/Version/Blocks/Scenes/Anchors/Assets/Tasks
- выдача подписанных ссылок на медиа (если S3)
- admin UI (на MVP)

### 2) `worker` (Celery)
Ответственность:
- импорт файла (MVP: txt)
- нормализация текста (правилами; опционально LLM-корректура)
- сегментация на сцены/якоря (гибрид)
- постановка задач генерации
- вызовы внешнего AI API для изображений
- сохранение ассетов и статусов

### 3) `redis`
Ответственность:
- брокер/бэкенд Celery на MVP

### 4) `db` (Postgres)
Ответственность:
- единый источник истины для контент-модели и статусов задач

### 5) `media` (S3/SeaweedFS)
Ответственность:
- хранение изображений/видео и вариантов
- CDN (опционально в prod)

### 6) `frontend-reader` (Vue)
Ответственность:
- рендеринг “книги” (клиентская пагинация)
- отображение иллюстраций по якорям
- UX перелистывания/разворота

Примечание: на MVP менеджерка может жить в `web` (Django Admin). Позже выносится в отдельный `frontend-admin` (Vue SPA).

## Как выглядит поток данных (MVP)

### 1) Создание черновика
Менеджер в админке:
- создаёт Story (draft)
- загружает `.txt`
- выбирает `StylePreset` и “контентный пресет” (сколько иллюстраций)
- нажимает “Запустить обработку”

### 2) Пайплайн в очереди
Celery выполняет цепочку:
- IMPORT_TEXT → NORMALIZE_TEXT → SEGMENT_SCENES → PLAN_ANCHORS → GENERATE_IMAGE*

* `GENERATE_IMAGE` — на каждую сцену/якорь (по пресету).

### 3) Ревью
Менеджер открывает кастомную страницу Review:
- видит список сцен, текст, текущие ассеты/варианты
- принимает/отклоняет/перегенерирует

### 4) Публикация
Менеджер нажимает “Опубликовать версию”:
- активной становится конкретная `StoryVersion`
- читалка отдаёт только опубликованную версию

## Менеджерка на MVP: что именно делаем в Django Admin

### Почему не “голый CRUD”
Нужны быстрые действия и предпросмотр.

### Минимальный UX
- **Review view** (кастомный admin view для StoryVersion):
  - таблица/лента сцен
  - для каждой сцены:
    - текст сцены
    - текущая картинка + миниатюры вариантов
    - кнопки: regenerate / edit scene card / approve
- **Preview view**:
  - iframe или ссылка на reader-frontend в sandbox-режиме (доступ по правам/токену)
  - переключатели device preset (phone/tablet) на стороне фронта

### Обновление статусов
- MVP: polling статусов задач и ассетов раз в N секунд.

## Политики, которые фиксируем сразу (чтобы не переделывать)

### 1) Версии
- опубликованная версия “заморожена”
- правки → новая версия (или черновая копия), чтобы не ломать опубликованный контент

### 2) Идемпотентность генерации
Идемпотентный ключ генерации включает:
- version + scene/anchor + format + style_preset_revision

### 3) Инвалидация
Если изменилось:
- текст сцены / scene card → инвалидируем только ассеты сцены
- style preset revision → инвалидируем ассеты, зависящие от этого стиля

### 4) Лимиты
- лимит перегенераций на сцену
- общий “бюджет” на StoryVersion

## Dev vs Prod (практично)

### Dev (локально)
- Postgres + Redis + SeaweedFS (S3) поднимаются контейнерами
- Django web и Celery worker можно тоже в контейнерах или на хосте (как удобнее команде)
- медиа хранятся в SeaweedFS (S3)

### Prod
- Postgres (managed или контейнер)
- Redis (managed или контейнер)
- web + worker как отдельные сервисы (docker compose/k8s)
- S3/R2 для медиа
- секреты через env/secret manager

## Что оставляем на “потом” (с ясным апгрейд-путём)
- URL-краулинг и умный импорт ссылок
- WebSocket обновления
- Вынос менеджерки в Vue SPA
- Видео-генерация
- Автоматические “сигналы качества” (style/scene similarity) — как подсказки, не автомодерация
