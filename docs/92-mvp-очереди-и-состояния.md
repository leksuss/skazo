# MVP: очереди, состояния, идемпотентность (заменяемый слой)

## Зачем отдельный документ
При “десятках в день” критично, чтобы пайплайн был:
- наблюдаемым (видно где зависло),
- повторяемым (можно перезапустить),
- экономным (не плодить дубли).

## Типы задач (концептуально, для Celery)
- `IMPORT_TEXT`
- `NORMALIZE_TEXT`
- `SEGMENT_SCENES`
- `PLAN_ANCHORS`
- `GENERATE_IMAGE` (на сцену/якорь, возможно несколько форматов)
- `GENERATE_VIDEO` (позже)

## Статусы задач
Минимальный набор:
- `queued`
- `running`
- `succeeded`
- `failed` (с error_message / error_type)
- `cancelled` (если менеджер отменил/заменил)

## Статусы версии/произведения (MVP)
Примерно:
- `draft`
- `processing`
- `review`
- `published`

## Идемпотентность
Каждая задача должна иметь:
- **идемпотентный ключ**, например:
  - (version_id, task_type, scene_id, format, style_preset_revision)

Правило:
- повторная постановка задачи с тем же ключом не создаёт дубликат ассета, а “подхватывает” существующий результат или перезаписывает его по политике.

## Ретраи и лимиты
- экспоненциальная задержка на ретраях (по сетевым ошибкам внешнего API)
- лимиты перегенераций:
  - N попыток на сцену
  - общий бюджет на story/version

## Наблюдаемость
Минимум:
- хранить историю попыток задачи,
- хранить параметры генерации (без секретов),
- логировать время выполнения и стоимость (если доступно от провайдера).
